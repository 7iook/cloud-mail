name = "cloud-mail"
main = "src/index.js"
compatibility_date = "2025-06-04"
keep_vars = true

# IMPORTANT: D1 and KV Bindings Configuration
# Bindings are defined in both default and [env.production] sections
# This ensures bindings work for all deployment methods
#
# For local development, bindings are configured via wrangler dev with local simulation
# For production deployment, use: wrangler deploy --env production

# Default D1 Database binding (for auto-deployment systems)
[[d1_databases]]
binding = "db"
database_name = "email"
database_id = "c8949d04-233c-4fc1-8792-89703a408842"

# Default Workers KV binding (for auto-deployment systems)
[[kv_namespaces]]
binding = "kv"
id = "23ab4c58dc4a4f269a34cd3b76e46968"

# Production environment configuration (for explicit --env production deployments)
[env.production]
name = "cloud-mail"

# D1 Database binding for production
[[env.production.d1_databases]]
binding = "db"
database_name = "email"
database_id = "c8949d04-233c-4fc1-8792-89703a408842"

# Workers KV binding for production
[[env.production.kv_namespaces]]
binding = "kv"
id = "23ab4c58dc4a4f269a34cd3b76e46968"

[observability]
enabled = true

# Rate Limiting Configuration (only limits malicious users)
# Uncomment the following configuration to enable rate limiting
#[[ratelimits]]
#name = "STRICT_RATE_LIMITER"
#namespace_id = "1001"
#simple = { limit = 5, period = 1 }  # Max 5 requests per 1 second

#[[ratelimits]]
#name = "MODERATE_RATE_LIMITER"
#namespace_id = "1002"
#simple = { limit = 20, period = 10 }  # Max 20 requests per 10 seconds

#[[ratelimits]]
#name = "LOOSE_RATE_LIMITER"
#namespace_id = "1003"
#simple = { limit = 60, period = 60 }  # Max 60 requests per 60 seconds

#[[r2_buckets]]
#binding = "r2"  # R2 object storage binding name (cannot be modified by default)
#bucket_name = ""  # R2 bucket name

[assets]
binding = "assets"  # Static resource binding name (cannot be modified by default)
directory = "./dist"  # Frontend Vue project build output directory (default: dist)
not_found_handling = "single-page-application"
run_worker_first = true

[triggers]
crons = ["0 16 * * *"]  # Scheduled task runs daily at 12 PM

[vars]
orm_log = false

# SECURITY NOTE: Application Secrets Configuration
# ================================================
# Sensitive configuration (domain, admin, jwt_secret) should be managed as secrets, not vars.
#
# For Production:
#   1. Set secrets via Cloudflare Dashboard or use: npx wrangler secret put SECRET_NAME --env production
#   2. Secrets are encrypted and never exposed in code or logs
#   3. Secrets persist across deployments
#
# For Local Development:
#   1. Copy mail-worker/.dev.vars.example to mail-worker/.dev.vars
#   2. Fill in your local development values
#   3. .dev.vars is automatically loaded by wrangler dev and ignored by git
#
# For GitHub Actions CI/CD:
#   1. Set secrets in GitHub repository Settings > Secrets and variables > Actions
#   2. Reference them in workflows as: ${{ secrets.SECRET_NAME }}
#   3. Use: npx wrangler secret put SECRET_NAME --env production <<< "${{ secrets.SECRET_NAME }}"

[build]
command = "pnpm --prefix ../mail-vue install && pnpm --prefix ../mail-vue run build"
