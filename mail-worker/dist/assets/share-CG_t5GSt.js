import{a5 as Fe,a4 as ze,A as n,J as fe,l as De,G as Ne,am as Pe,e as i,g as s,f as u,a7 as r,p as Z,t as h,q as p,ah as Ke,O as Be,i as k,a$ as Oe,h as Q,bk as Ge,a1 as D,bl as Je,ad as I,o,Q as Ue,af as We}from"./index-92mnh-J5.js";import{o as qe,p as se,v as je}from"./share-wibObi1U.js";import{E as He}from"./el-image-viewer-DJ_SH_7Y.js";import{E as Ze}from"./el-overlay-jTA8uYnN.js";import{E as Qe,a as Xe}from"./el-carousel-item-Bu3eEokz.js";/* empty css                 *//* empty css                  */import{a as Ye}from"./el-tag-Dck20whD.js";import{u as ea}from"./email-9j19DGMK.js";import{u as aa,E as ta,e as la}from"./index-DzjioUTY.js";import{L as na,S as sa}from"./LayoutModeSelector-B-li_gUo.js";import{E as oa}from"./EmailDetailPane-CMJxr8Q_.js";import{_ as ia}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{E as ra}from"./index-CG9L6tLM.js";import{E as ua}from"./vnode-DfneDD37.js";import"./throttle-BQKBmdXm.js";import"./iconify-VCTUy_UH.js";import"./index-B-u1Rqw0.js";import"./validator-Cw4sOcG_.js";import"./index-ChZfA3gH.js";import"./time-utils-8_bD8pZw.js";import"./el-scrollbar-lgMH0mZQ.js";import"./el-empty-CKfYwwv3.js";import"./el-tooltip-l0sNRNKZ.js";import"./el-checkbox-DpAuy9Ti.js";import"./index-UYGPyXpS.js";import"./el-skeleton-item-UTnpAQ6A.js";import"./day-DI1_lKIq.js";import"./dayjs.min-BodJrPHb.js";import"./email-highlight-utils-Dx-h0BtP.js";import"./clipboard-utils-Bf-9Um4a.js";/* empty css                       */const ca={class:"share-page"},da={class:"page-header"},va={class:"header-left"},ma={key:0,class:"config-info"},pa={class:"email-address"},fa={class:"header-right"},ga={key:0,class:"auto-refresh-status"},ha={key:0,class:"refresh-active"},ya={key:1,class:"refresh-paused"},wa={key:2,class:"new-emails-badge"},_a={key:0,class:"loading-container"},ka={"element-loading-text":"加载中..."},Ea={key:1,class:"captcha-container"},ba={class:"captcha-box"},Ia={class:"captcha-content"},Sa={key:2,class:"rate-limit-error-container"},Ca={class:"rate-limit-error"},Aa={class:"error-content"},Ta={key:0,class:"retry-countdown"},xa={key:3,style:{display:"none"}},$a={key:4,class:"emails-container"},La={key:0,class:"announcement-button-container"},Ra={key:1,class:"email-verification-section"},Va={class:"verification-form"},Ma={key:0,class:"verification-error"},Fa={class:"announcement-content"},za={key:0,class:"images-carousel"},Da={class:"carousel-item"},Na=["src","alt","onClick"],Pa={key:0,class:"image-caption"},Ka={class:"carousel-info"},Ba=["innerHTML"],Oa={key:2,class:"announcement-text"},Ga={class:"dialog-footer"},Ja={__name:"share",setup(Ua){const w=Fe().params.token,S=ea(),ge=ze(),oe=n(window.innerWidth<768),ie=()=>{oe.value=window.innerWidth<768};fe(()=>{(!S.splitLayout||S.splitLayout.mode==="none")&&S.setSplitMode("right")});const $=n(!0),X=n(""),J=n(null),E=n({}),d=n(null),y=n(""),U=n(!1),f=n(""),Y=n(!1),N=n(""),P=n(!1),W=n(30),A=n(!1),C=n(!1),L=n(0),R=n(0);let T=null,b=null;const q=n(!1),V=n(""),ee=n(!1),K=n(0),re=De(()=>K.value>0);let M=null;const B=n(null),F=n(0);let j=null;const{previewVisible:ae,previewEmail:he,openPreview:ye,closePreview:we}=aa(),O=n(!1),ue=n(!1);n(null);const v=n(null),G=n(0),te=n(!1),z=n(null),_e=a=>({1:"单邮箱分享",2:"邮箱输入分享"})[a]||"未知类型",ke=a=>{const{splitLayout:e}=S;e.mode==="none"||typeof window<"u"&&window.innerWidth<1025?ye(a):S.selectEmail(a)},Ee=(a,e)=>{if(d.value?.shareType===2&&!Y.value)return Promise.resolve({list:[],total:0,latestEmail:null});const t={emailId:a||0,size:e||20};return d.value?.shareType===2&&N.value&&(t.userEmail=N.value),se(w,t).then(l=>({list:l.emails||[],total:l.total||0,latestEmail:l.emails&&l.emails.length>0?l.emails[0]:null}))},le=async()=>{try{const a=await qe(w);d.value=a,J.value=a,P.value=a.autoRefreshEnabled===1,W.value=a.autoRefreshInterval||30,a.shareType===1?(Y.value=!0,P.value&&D(()=>{H()})):a.shareType===2&&P.value&&D(()=>{H()}),B.value=null,F.value=0;try{const l=await Je();z.value=l}catch(l){console.error("获取全局公告失败:",l),z.value=null}let e=null,t=null;if(console.log("[DEBUG] globalAnnouncement.value:",z.value),a.announcementContent)e=a.announcementContent,t="share";else if(z.value?.enabled&&z.value?.overrideShareAnnouncement){const{title:l,content:c,images:g,displayMode:_}=z.value;console.log("[DEBUG] Global announcement data:",{title:l,content:c,images:g,displayMode:_}),l||g&&g.length>0?e=JSON.stringify({type:"rich",title:l||"",content:c||"",images:g||[],displayMode:_||"always"}):e=c,t="global",console.log("[DEBUG] announcementToShow:",e)}if(e){Te(e);const l=v.value?.displayMode||"always",c=`announcement_version_${w}`,g=`announcement_viewed_${w}`;let _=!1;l==="always"?_=!0:l==="once"?_=!localStorage.getItem(g):_=!0,_&&D(()=>{O.value=!0,ue.value=!0,G.value=0})}else{const l=`announcement_viewed_${w}`;localStorage.removeItem(l)}$.value=!1}catch(a){if(console.error("加载分享信息失败:",a),(a.status===403||a.code===403)&&a.headers?.["x-captcha-required"]==="true"){console.log("检测到需要人机验证"),q.value=!0,$.value=!1,D(()=>{Ce()});return}if(a.status===429||a.code===429){const e=a.retryAfter||60;B.value=`访问过于频繁，请在 ${e} 秒后重试`,F.value=e,j&&clearInterval(j),j=setInterval(()=>{F.value--,F.value<=0&&(clearInterval(j),le())},1e3),$.value=!1;return}if(a.status===404||a.code===404){window.location.href="/404-not-found-page-that-does-not-exist";return}X.value="",$.value=!1,window.location.href="/404-not-found-page-that-does-not-exist"}};Ne(y,()=>{f.value&&(f.value="")});const be=()=>{if(!d.value?.cooldownEnabled)return;const a=d.value?.cooldownSeconds||10;K.value=a,M=setInterval(()=>{K.value--,K.value<=0&&(clearInterval(M),M=null)},1e3)},ce=async()=>{if(!y.value||!y.value.trim()){f.value="请输入邮箱地址";return}if(!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(y.value.trim())){f.value="请输入有效的邮箱地址";return}const e=254;if(y.value.trim().length>e){f.value=`邮箱地址过长（最多${e}个字符）`;return}U.value=!0,f.value="";try{const t=y.value.trim().toLowerCase();await se(w,{userEmail:t}),Y.value=!0,N.value=t,J.value.emailAddress=y.value,await D(),E.value?.refresh&&E.value.refresh(),P.value&&D(()=>{H()}),be(),y.value="",I.success("邮箱验证成功")}catch(t){console.error("Email verification failed:",t),t.message&&t.message.includes("不在此分享的授权列表中")?f.value="该邮箱不在授权列表中":t.message&&t.message.includes("邮箱地址无效")?f.value="邮箱地址无效":t.message&&t.message.includes("邮箱地址过长")?f.value="邮箱地址过长":t.message&&t.message.includes("已被删除")?f.value="邮箱账户已被删除":f.value="验证失败，请重试"}finally{U.value=!1}},H=()=>{if(!d.value?.autoRefreshEnabled||A.value)return;A.value=!0,C.value=!1,R.value=W.value;const a=()=>{b&&clearInterval(b),R.value=W.value,b=setInterval(()=>{R.value>0&&R.value--},1e3)};(async()=>{for(;A.value&&!C.value;)try{if(a(),await new Promise(g=>{T=setTimeout(g,W.value*1e3)}),!A.value||C.value)break;const l={emailId:E.value.latestEmail?.emailId||0,size:20};d.value?.shareType===2&&N.value&&(l.userEmail=N.value);const c=await se(w,l);if(c.emails&&c.emails.length>0){const g=E.value.latestEmail?.emailId||0;c.emails.some(x=>x.emailId>g)&&(E.value&&typeof E.value.addItem=="function"?(c.emails.forEach(x=>{x.emailId>g&&(E.value.addItem(x),L.value++)}),L.value>0&&(I.success(`收到 ${L.value} 封新邮件`),setTimeout(()=>{L.value=0},3e3))):console.warn("emailScroll组件未正确初始化，无法添加新邮件"))}}catch(t){console.error("自动刷新失败:",t),(t.message.includes("网络")||t.message.includes("timeout"))&&(de(),I.warning("网络连接异常，已暂停自动刷新"))}})()},de=()=>{C.value=!0,T&&(clearTimeout(T),T=null),b&&(clearInterval(b),b=null)},Ie=()=>{A.value&&(C.value=!1,H())},Se=()=>{A.value=!1,C.value=!1,T&&(clearTimeout(T),T=null),b&&(clearInterval(b),b=null),R.value=0},Ce=()=>{const a=ge.settings?.siteKey||"1x00000000000000000000AA";if(window.turnstile)window.turnstile.render("#cf-turnstile",{sitekey:a,theme:"light",callback:ve,"error-callback":me});else{const e=document.createElement("script");e.src="https://challenges.cloudflare.com/turnstile/v0/api.js",e.async=!0,e.defer=!0,e.onload=()=>{window.turnstile.render("#cf-turnstile",{sitekey:a,theme:"light",callback:ve,"error-callback":me})},document.head.appendChild(e)}},ve=a=>{console.log("Turnstile验证成功，token:",a),V.value=a},me=()=>{console.error("Turnstile验证失败"),I.error("人机验证失败，请重试")},Ae=async()=>{if(!V.value){I.error("请先完成人机验证");return}try{ee.value=!0;const a=await fetch("/api/share/verify-captcha",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:V.value,shareToken:w})});if(!a.ok)throw new Error("验证失败");const e=await a.json();if(e.code===0||e.success)I.success("验证成功，正在加载..."),q.value=!1,V.value="",await le();else throw new Error(e.message||"验证失败")}catch(a){console.error("验证错误:",a),I.error("验证失败: "+a.message),window.turnstile&&window.turnstile.reset(),V.value=""}finally{ee.value=!1}},Te=a=>{if(v.value=null,!!a)try{if(typeof a=="string"&&a.startsWith("{")){const e=JSON.parse(a);if(e.type==="rich"){v.value={title:e.title||"",content:e.content||"",images:e.images||[],displayMode:e.displayMode||"always"};return}}}catch(e){console.error("解析公告JSON失败:",e)}},pe=()=>{if(O.value=!1,v.value?.displayMode==="once"){const a=`announcement_viewed_${w}`;localStorage.setItem(a,JSON.stringify({viewedAt:new Date().toISOString(),version:v.value.version||0}))}},xe=a=>{if(!a)return"";let e=a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");return e=e.replace(/\[bold\](.*?)\[\/bold\]/g,"<strong>$1</strong>"),e=e.replace(/\[large\](.*?)\[\/large\]/g,'<span style="font-size: 18px;">$1</span>'),e=e.replace(/\[xlarge\](.*?)\[\/xlarge\]/g,'<span style="font-size: 22px;">$1</span>'),e=e.replace(/\[red\](.*?)\[\/red\]/g,'<span style="color: #FF0000;">$1</span>'),e=e.replace(/\[green\](.*?)\[\/green\]/g,'<span style="color: #00AA00;">$1</span>'),e=e.replace(/\[blue\](.*?)\[\/blue\]/g,'<span style="color: #0066FF;">$1</span>'),e=e.replace(/\[yellow\](.*?)\[\/yellow\]/g,'<span style="color: #FFAA00;">$1</span>'),e=e.replace(/\[highlight\](.*?)\[\/highlight\]/g,'<mark style="background-color: #FFFF00; padding: 2px 4px;">$1</mark>'),e=e.replace(/\[link\](.*?)\[\/link\]/g,'<span class="announcement-link-wrapper"><a href="$1" target="_blank" style="color: #0066FF; text-decoration: underline; cursor: pointer;" class="announcement-link" data-url="$1">$1</a><span class="announcement-link-copy" data-url="$1" title="复制链接">📋</span></span>'),e=e.replace(/(?<!<a[^>]*>)(https?:\/\/[^\s<>"{}|\\^`\[\]]+|www\.[^\s<>"{}|\\^`\[\]]+)(?![^<]*<\/a>)/g,t=>{const l=t.startsWith("www.")?"https://"+t:t;return`<span class="announcement-link-wrapper"><a href="${l}" target="_blank" style="color: #0066FF; text-decoration: underline; cursor: pointer;" class="announcement-link" data-url="${l}">${t}</a><span class="announcement-link-copy" data-url="${l}" title="复制链接">📋</span></span>`}),e=e.replace(/\n/g,"<br>"),e},$e=a=>{const e=a.target;if(e.classList.contains("announcement-link-copy")){a.preventDefault(),a.stopPropagation();const t=e.getAttribute("data-url");t&&navigator.clipboard.writeText(t).then(()=>{I.success("链接已复制到剪贴板")}).catch(()=>{I.error("复制失败，请手动复制")})}},Le=a=>{G.value=a,te.value=!0};return fe(async()=>{S.emailScroll=E,S.loadSplitLayoutFromStorage();const a=`announcement_shown_${w}`;localStorage.getItem(a)&&(ue.value=!0),window.addEventListener("resize",ie),await le()}),Pe(()=>{Se(),M&&(clearInterval(M),M=null),window.removeEventListener("resize",ie)}),(a,e)=>{const t=Ye,l=Ke("Icon"),c=ra,g=ua,_=Xe,x=Qe,Re=Ze,Ve=He,Me=je;return o(),i("div",ca,[s("div",da,[s("div",va,[e[6]||(e[6]=s("h2",null,"📨 验证码邮件分享",-1)),J.value?(o(),i("div",ma,[s("span",pa,h(J.value.emailAddress),1),r(t,{size:"small",type:"info"},{default:p(()=>[k(h(_e(d.value?.shareType)),1)]),_:1})])):u("",!0)]),s("div",fa,[P.value?(o(),i("div",ga,[A.value&&!C.value?(o(),i("div",ha,[r(l,{icon:"material-symbols:refresh",class:"rotating"}),s("span",null,"自动刷新中 ("+h(R.value)+"s)",1),r(c,{size:"small",text:"",onClick:de},{default:p(()=>[...e[7]||(e[7]=[k("暂停",-1)])]),_:1})])):C.value?(o(),i("div",ya,[r(l,{icon:"material-symbols:pause"}),e[9]||(e[9]=s("span",null,"已暂停",-1)),r(c,{size:"small",type:"primary",onClick:Ie},{default:p(()=>[...e[8]||(e[8]=[k("恢复",-1)])]),_:1})])):u("",!0),L.value>0?(o(),i("div",wa,h(L.value)+" 封新邮件 ",1)):u("",!0)])):u("",!0),r(na)])]),$.value?(o(),i("div",_a,[Be((o(),i("div",ka,[...e[10]||(e[10]=[s("div",{style:{height:"200px"}},null,-1)])])),[[Me,!0]])])):u("",!0),q.value?(o(),i("div",Ea,[s("div",ba,[r(l,{icon:"material-symbols:verified-user",class:"captcha-icon"}),s("div",Ia,[e[12]||(e[12]=s("h3",null,"安全验证",-1)),e[13]||(e[13]=s("p",null,"为了保护您的账户安全，请完成人机验证",-1)),e[14]||(e[14]=s("div",{class:"turnstile-widget"},[s("div",{id:"cf-turnstile"})],-1)),r(c,{type:"primary",onClick:Ae,loading:ee.value,disabled:!V.value},{default:p(()=>[...e[11]||(e[11]=[k(" 验证并继续 ",-1)])]),_:1},8,["loading","disabled"])])])])):B.value?(o(),i("div",Sa,[s("div",Ca,[r(l,{icon:"material-symbols:schedule",class:"error-icon"}),s("div",Aa,[e[17]||(e[17]=s("h3",null,"访问过于频繁",-1)),s("p",null,h(B.value),1),F.value>0?(o(),i("p",Ta,[e[15]||(e[15]=k(" 将在 ",-1)),s("strong",null,h(F.value),1),e[16]||(e[16]=k(" 秒后自动重试... ",-1))])):u("",!0)])])])):X.value?(o(),i("div",xa)):u("",!0),!$.value&&!q.value&&!B.value&&!X.value?(o(),i("div",$a,[d.value?.announcementContent?(o(),i("div",La,[r(c,{type:"primary",text:"",onClick:e[0]||(e[0]=m=>O.value=!0),class:"announcement-button"},{default:p(()=>[r(l,{icon:"material-symbols:info"}),e[18]||(e[18]=k(" 查看公告 ",-1))]),_:1})])):u("",!0),d.value?.shareType===2?(o(),i("div",Ra,[e[19]||(e[19]=s("div",{class:"verification-header"},[s("h3",null,"邮箱验证"),s("p",null,"请输入您的邮箱地址以获取最新验证码")],-1)),s("div",Va,[r(g,{modelValue:y.value,"onUpdate:modelValue":e[1]||(e[1]=m=>y.value=m),placeholder:"请输入邮箱地址",size:"large",disabled:U.value,onKeyup:Oe(ce,["enter"]),class:"email-input"},{prefix:p(()=>[r(l,{icon:"material-symbols:email"})]),_:1},8,["modelValue","disabled"]),r(c,{type:"primary",size:"large",loading:U.value,onClick:ce,disabled:!y.value||d.value?.cooldownEnabled&&re.value},{default:p(()=>[k(h(d.value?.cooldownEnabled&&re.value?`请等待 ${K.value} 秒`:"获取最新验证码"),1)]),_:1},8,["loading","disabled"])]),f.value?(o(),i("div",Ma,[r(l,{icon:"material-symbols:error"}),k(" "+h(f.value),1)])):u("",!0)])):u("",!0),r(sa,{class:"split-container"},{list:p(()=>[d.value?(o(),Z(la,{key:0,ref_key:"scroll",ref:E,getEmailList:Ee,"time-sort":0,actionLeft:"4px","show-star":!1,"allow-star":!1,"allow-delete":!1,"show-account-icon":!1,onJump:ke},null,512)):u("",!0)]),detail:p(()=>[Q(S).splitLayout?.showDetailPane?(o(),Z(oa,{key:0})):u("",!0)]),_:1}),r(ta,{modelValue:Q(ae),"onUpdate:modelValue":e[2]||(e[2]=m=>Ge(ae)?ae.value=m:null),email:Q(he),onClosed:Q(we)},null,8,["modelValue","email","onClosed"])])):u("",!0),r(Re,{modelValue:O.value,"onUpdate:modelValue":e[4]||(e[4]=m=>O.value=m),title:v.value?.title||"公告",width:oe.value?"95vw":"600px","close-on-click-modal":!0,onClose:pe,class:"announcement-dialog"},{footer:p(()=>[s("div",Ga,[r(c,{onClick:pe},{default:p(()=>[...e[20]||(e[20]=[k("关闭",-1)])]),_:1})])]),default:p(()=>[s("div",Fa,[v.value?.images&&v.value.images.length>0?(o(),i("div",za,[r(x,{autoplay:!1,class:"carousel",onChange:e[3]||(e[3]=m=>G.value=m)},{default:p(()=>[(o(!0),i(Ue,null,We(v.value.images,(m,ne)=>(o(),Z(_,{key:ne},{default:p(()=>[s("div",Da,[s("img",{src:m.base64,alt:`Image ${ne+1}`,onClick:qa=>Le(ne),title:"点击查看全屏"},null,8,Na),m.caption?(o(),i("div",Pa,h(m.caption),1)):u("",!0)])]),_:2},1024))),128))]),_:1}),s("div",Ka,h(G.value+1)+" / "+h(v.value.images.length),1)])):u("",!0),v.value?.content?(o(),i("div",{key:1,class:"announcement-text",onClick:$e},[s("div",{innerHTML:xe(v.value.content)},null,8,Ba)])):u("",!0),!v.value&&d.value?.announcementContent?(o(),i("div",Oa,h(d.value.announcementContent),1)):u("",!0)])]),_:1},8,["modelValue","title","width"]),te.value&&v.value?.images?(o(),Z(Ve,{key:5,"url-list":v.value.images.map(m=>m.base64),"initial-index":G.value,onClose:e[5]||(e[5]=m=>te.value=!1)},null,8,["url-list","initial-index"])):u("",!0)])}}},Ct=ia(Ja,[["__scopeId","data-v-6ae9e6ed"]]);export{Ct as default};
