# ç”Ÿäº§ç¯å¢ƒé‚®ä»¶åˆ†äº«ç³»ç»Ÿæ•…éšœä¿®å¤æ€»ç»“

**ä¿®å¤æ—¥æœŸ**: 2025-01-14  
**ç¯å¢ƒ**: https://7ix.asia/email-share  
**çŠ¶æ€**: éƒ¨åˆ†å®Œæˆ,éœ€è¦ç”¨æˆ·æ‰§è¡Œæ•°æ®åº“ä¿®å¤

---

## ğŸ“‹ é—®é¢˜æ€»ç»“

### âœ… é—®é¢˜ 1: Token åˆ·æ–°é€»è¾‘
**çŠ¶æ€**: æ— é—®é¢˜  
**ç»“è®º**: ä»£ç å®¡æŸ¥ç¡®è®¤ JWT éªŒè¯å’Œ Token åˆ·æ–°é€»è¾‘å®ç°æ­£ç¡®,æ— éœ€ä¿®å¤ã€‚

### âš ï¸ é—®é¢˜ 2: åˆ›å»ºé‚®ä»¶åˆ†äº«å¤±è´¥ (500é”™è¯¯)
**çŠ¶æ€**: å·²å¤ç°,éœ€è¦åç«¯æ—¥å¿—åˆ†æ  
**ç°è±¡**: 
- å‰ç«¯æç¤º"æœåŠ¡å™¨ç¹å¿™,è¯·ç¨åé‡è¯•"
- POST `/api/share/create` è¿”å› 500 çŠ¶æ€ç 
- ç”¨æˆ·æ— æ³•åˆ›å»ºæ–°çš„é‚®ä»¶åˆ†äº«

**éœ€è¦çš„æ“ä½œ**:
1. æŸ¥çœ‹ Cloudflare Workers ç”Ÿäº§ç¯å¢ƒæ—¥å¿—
2. å®šä½ 500 é”™è¯¯çš„å…·ä½“åŸå› 
3. ä¿®å¤ä»£ç æˆ–é…ç½®é—®é¢˜
4. é‡æ–°éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

### âœ… é—®é¢˜ 3: åˆ†äº«é“¾æ¥åŸŸåé”™è¯¯
**çŠ¶æ€**: å·²ç¡®è®¤æ ¹æœ¬åŸå› ,ä¿®å¤è„šæœ¬å·²å‡†å¤‡å°±ç»ª  
**ç°è±¡**:
- æ‰€æœ‰11ä¸ªåˆ†äº«é“¾æ¥æ˜¾ç¤ºä¸º `https://share_domain/share/...`
- æ­£ç¡®æ ¼å¼åº”è¯¥æ˜¯ `https://7ix.asia/share/...`

**æ ¹æœ¬åŸå› **:
- æ•°æ®åº“ `share` è¡¨ä¸­çš„ `share_domain` å­—æ®µå­˜å‚¨äº†å­—é¢å­—ç¬¦ä¸² `"share_domain"`
- åº”è¯¥å­˜å‚¨å®é™…åŸŸå(å¦‚ `"7ix.asia"`)æˆ– `NULL`(ä½¿ç”¨é»˜è®¤åŸŸå)

**ä¿®å¤æ–¹æ¡ˆ**:
- å·²åˆ›å»ºæ•°æ®åº“ä¿®å¤è„šæœ¬: `mail-worker/migrations/005_fix_share_domain_data.sql`
- å°†æ‰€æœ‰é”™è¯¯æ•°æ®æ›´æ–°ä¸º `NULL`,ä½¿ç”¨ç³»ç»Ÿé»˜è®¤åŸŸå

---

## ğŸ”§ å·²å®Œæˆçš„å·¥ä½œ

### 1. åˆ›å»ºæ•°æ®åº“ä¿®å¤è„šæœ¬
**æ–‡ä»¶**: `mail-worker/migrations/005_fix_share_domain_data.sql`

**åŠŸèƒ½**:
- å°† `share_domain = 'share_domain'` çš„è®°å½•æ›´æ–°ä¸º `NULL`
- æä¾›æ•°æ®éªŒè¯æŸ¥è¯¢
- åŒ…å«è¯¦ç»†çš„æ‰§è¡Œè¯´æ˜å’Œå¤‡ä»½æç¤º

### 2. åˆ›å»ºè¯Šæ–­æŠ¥å‘Š
**æ–‡ä»¶**: `PRODUCTION_ISSUES_DIAGNOSIS_REPORT.md`

**å†…å®¹**:
- å®Œæ•´çš„é—®é¢˜è¯Šæ–­è¿‡ç¨‹
- Playwright æµè§ˆå™¨æµ‹è¯•ç»“æœ
- æ ¹æœ¬åŸå› åˆ†æ
- ä¿®å¤æ–¹æ¡ˆå’Œæ‰§è¡Œæ­¥éª¤
- æµ‹è¯•éªŒè¯æ¸…å•

### 3. åˆ›å»ºè¯Šæ–­æŠ¥å‘Š(è¯¦ç»†ç‰ˆ)
**æ–‡ä»¶**: `PRODUCTION_ISSUES_DIAGNOSIS_2025-01-14.md`

**å†…å®¹**:
- æ›´è¯¦ç»†çš„æŠ€æœ¯åˆ†æ
- ä»£ç å®¡æŸ¥ç»“æœ
- å½±å“è¯„ä¼°
- å®Œæ•´çš„ä¿®å¤æ¸…å•
- æµ‹è¯•ç”¨ä¾‹

---

## ğŸš€ éœ€è¦ç”¨æˆ·æ‰§è¡Œçš„æ“ä½œ

### æ­¥éª¤ 1: ä¿®å¤é—®é¢˜ 3 (åˆ†äº«é“¾æ¥åŸŸåé”™è¯¯)

#### 1.1 å¤‡ä»½æ•°æ®åº“
```bash
npx wrangler d1 backup create cloud-mail-db
```

#### 1.2 æ‰§è¡Œä¿®å¤è„šæœ¬
```bash
cd f:\Email\cloud-mail\mail-worker
npx wrangler d1 execute cloud-mail-db --remote --file=./migrations/005_fix_share_domain_data.sql
```

#### 1.3 éªŒè¯ä¿®å¤ç»“æœ
```bash
npx wrangler d1 execute cloud-mail-db --remote --command="SELECT share_id, target_email, share_domain, CASE WHEN share_domain IS NULL THEN 'ä½¿ç”¨é»˜è®¤åŸŸå' WHEN share_domain = 'share_domain' THEN 'é”™è¯¯æ•°æ®' ELSE 'è‡ªå®šä¹‰åŸŸå: ' || share_domain END as domain_status FROM share ORDER BY create_time DESC LIMIT 5"
```

**é¢„æœŸè¾“å‡º**:
```
share_id | target_email              | share_domain | domain_status
---------|---------------------------|--------------|---------------
11       | 4kcv47zs634elo2gfow5@...  | NULL         | ä½¿ç”¨é»˜è®¤åŸŸå
10       | 4kcv4237zs634elo2gfow5... | NULL         | ä½¿ç”¨é»˜è®¤åŸŸå
9        | 3wrs4@7ix.asia            | NULL         | ä½¿ç”¨é»˜è®¤åŸŸå
...
```

#### 1.4 åˆ·æ–°æµè§ˆå™¨éªŒè¯
1. è®¿é—® https://7ix.asia/email-share
2. æŒ‰ `Ctrl+F5` å¼ºåˆ¶åˆ·æ–°é¡µé¢
3. æ£€æŸ¥"åˆ†äº«é“¾æ¥"åˆ—,æ‰€æœ‰é“¾æ¥åº”æ˜¾ç¤ºä¸º `https://7ix.asia/share/...`
4. ç‚¹å‡»ä»»æ„åˆ†äº«é“¾æ¥,éªŒè¯å¯ä»¥æ­£å¸¸è®¿é—®

---

### æ­¥éª¤ 2: è¯Šæ–­é—®é¢˜ 2 (åˆ›å»ºåˆ†äº«å¤±è´¥)

#### 2.1 å¯åŠ¨å®æ—¶æ—¥å¿—ç›‘æ§
```bash
cd f:\Email\cloud-mail\mail-worker
npx wrangler tail --env production
```

**æ³¨æ„**: è¿™ä¸ªå‘½ä»¤éœ€è¦è®¾ç½® `CLOUDFLARE_API_TOKEN` ç¯å¢ƒå˜é‡ã€‚

**è·å– API Token**:
1. è®¿é—® https://dash.cloudflare.com/profile/api-tokens
2. ç‚¹å‡»"Create Token"
3. é€‰æ‹©"Edit Cloudflare Workers"æ¨¡æ¿
4. åˆ›å»º Token å¹¶å¤åˆ¶

**è®¾ç½®ç¯å¢ƒå˜é‡** (PowerShell):
```powershell
$env:CLOUDFLARE_API_TOKEN="your-api-token-here"
npx wrangler tail --env production
```

#### 2.2 å¤ç°é”™è¯¯å¹¶æŸ¥çœ‹æ—¥å¿—
1. ä¿æŒæ—¥å¿—ç›‘æ§çª—å£æ‰“å¼€
2. åœ¨æµè§ˆå™¨ä¸­è®¿é—® https://7ix.asia/email-share
3. ç‚¹å‡»"åˆ›å»ºåˆ†äº«"æŒ‰é’®
4. é€‰æ‹©ä¸€ä¸ªé‚®ç®±
5. ç‚¹å‡»"åˆ›å»ºåˆ†äº«"æäº¤
6. è§‚å¯Ÿæ—¥å¿—çª—å£ä¸­çš„é”™è¯¯ä¿¡æ¯

#### 2.3 åˆ†æé”™è¯¯æ—¥å¿—
æŸ¥æ‰¾ä»¥ä¸‹å…³é”®ä¿¡æ¯:
- é”™è¯¯å †æ ˆè·Ÿè¸ª
- æ•°æ®åº“æ“ä½œå¤±è´¥ä¿¡æ¯
- çº¦æŸè¿åé”™è¯¯
- JSON åºåˆ—åŒ–é”™è¯¯

#### 2.4 æ ¹æ®æ—¥å¿—ä¿®å¤ä»£ç 
æ ¹æ®é”™è¯¯ä¿¡æ¯,å¯èƒ½éœ€è¦ä¿®å¤:
- `mail-worker/src/api/share-api.js` - åˆ›å»ºåˆ†äº« API
- `mail-worker/src/service/share-service.js` - åˆ†äº«æœåŠ¡é€»è¾‘
- `mail-worker/src/entity/share.js` - æ•°æ®åº“å®ä½“å®šä¹‰

---

### æ­¥éª¤ 3: æäº¤ä¿®å¤ä»£ç 

#### 3.1 æŸ¥çœ‹ä¿®æ”¹çš„æ–‡ä»¶
```bash
cd f:\Email\cloud-mail
git status
```

#### 3.2 æ·»åŠ æ‰€æœ‰ä¿®æ”¹
```bash
git add .
```

#### 3.3 æäº¤ä¿®å¤
```bash
git commit -m "fix: ä¿®å¤ç”Ÿäº§ç¯å¢ƒåˆ†äº«é“¾æ¥åŸŸåé”™è¯¯

- åˆ›å»ºæ•°æ®åº“ä¿®å¤è„šæœ¬ 005_fix_share_domain_data.sql
- ä¿®å¤ share_domain å­—æ®µå­˜å‚¨é”™è¯¯æ•°æ®çš„é—®é¢˜
- å°†æ‰€æœ‰ 'share_domain' å­—é¢å­—ç¬¦ä¸²æ›´æ–°ä¸º NULL
- æ·»åŠ è¯¦ç»†çš„è¯Šæ–­æŠ¥å‘Šå’Œä¿®å¤æ–‡æ¡£

é—®é¢˜:
- æ‰€æœ‰åˆ†äº«é“¾æ¥æ˜¾ç¤ºä¸º https://share_domain/share/...
- åº”è¯¥æ˜¾ç¤ºä¸º https://7ix.asia/share/...

æ ¹æœ¬åŸå› :
- æ•°æ®åº“ä¸­ share_domain å­—æ®µå­˜å‚¨äº†å­—é¢å­—ç¬¦ä¸² 'share_domain'
- åº”è¯¥å­˜å‚¨å®é™…åŸŸåæˆ– NULL

ä¿®å¤æ–¹æ¡ˆ:
- æ‰§è¡Œ SQL: UPDATE share SET share_domain = NULL WHERE share_domain = 'share_domain'
- ç³»ç»Ÿå°†ä½¿ç”¨ç¯å¢ƒå˜é‡ domain ä¸­çš„é»˜è®¤åŸŸå

å½±å“:
- ä¿®å¤æ‰€æœ‰11ä¸ªç°æœ‰åˆ†äº«è®°å½•çš„é“¾æ¥æ˜¾ç¤º
- ç”¨æˆ·å¯ä»¥æ­£å¸¸è®¿é—®åˆ†äº«é“¾æ¥"
```

#### 3.4 æ¨é€åˆ°è¿œç¨‹ä»“åº“
```bash
git push origin main
```

---

## ğŸ“Š ä¿®å¤éªŒè¯æ¸…å•

### é—®é¢˜ 3 éªŒè¯
- [ ] æ•°æ®åº“ä¿®å¤è„šæœ¬æ‰§è¡ŒæˆåŠŸ
- [ ] æ‰€æœ‰åˆ†äº«è®°å½•çš„ `share_domain` å­—æ®µå·²æ›´æ–°ä¸º `NULL`
- [ ] å‰ç«¯åˆ†äº«åˆ—è¡¨æ˜¾ç¤ºæ­£ç¡®çš„é“¾æ¥æ ¼å¼ `https://7ix.asia/share/...`
- [ ] ç‚¹å‡»åˆ†äº«é“¾æ¥å¯ä»¥æ­£å¸¸è®¿é—®
- [ ] å¤åˆ¶åˆ†äº«é“¾æ¥å¾—åˆ°æ­£ç¡®çš„ URL

### é—®é¢˜ 2 éªŒè¯
- [ ] è·å–åˆ°ç”Ÿäº§ç¯å¢ƒåç«¯æ—¥å¿—
- [ ] å®šä½åˆ° 500 é”™è¯¯çš„å…·ä½“åŸå› 
- [ ] ä¿®å¤ä»£ç æˆ–é…ç½®é—®é¢˜
- [ ] é‡æ–°éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- [ ] å¯ä»¥æˆåŠŸåˆ›å»ºæ–°çš„é‚®ä»¶åˆ†äº«
- [ ] æ–°åˆ›å»ºçš„åˆ†äº«é“¾æ¥æ ¼å¼æ­£ç¡®

---

## ğŸ¯ é¢„æœŸç»“æœ

### ä¿®å¤åçš„ç³»ç»ŸçŠ¶æ€
1. âœ… æ‰€æœ‰ç°æœ‰åˆ†äº«é“¾æ¥æ˜¾ç¤ºæ­£ç¡®åŸŸå
2. âœ… ç”¨æˆ·å¯ä»¥æ­£å¸¸è®¿é—®åˆ†äº«é“¾æ¥
3. âœ… ç”¨æˆ·å¯ä»¥æˆåŠŸåˆ›å»ºæ–°çš„é‚®ä»¶åˆ†äº«
4. âœ… æ–°åˆ›å»ºçš„åˆ†äº«é“¾æ¥æ ¼å¼æ­£ç¡®
5. âœ… ç³»ç»ŸåŠŸèƒ½å®Œå…¨æ¢å¤æ­£å¸¸

### ç”¨æˆ·ä½“éªŒæ”¹å–„
1. åˆ†äº«é“¾æ¥æ˜¾ç¤ºä¸“ä¸š,å¢å¼ºç”¨æˆ·ä¿¡ä»»
2. æ ¸å¿ƒåŠŸèƒ½æ¢å¤,ç”¨æˆ·å¯ä»¥æ­£å¸¸ä½¿ç”¨
3. ç³»ç»Ÿç¨³å®šæ€§æå‡,å‡å°‘é”™è¯¯å‘ç”Ÿ

---

## ğŸ“ åç»­å»ºè®®

### 1. æ·»åŠ æ•°æ®éªŒè¯
åœ¨åˆ›å»ºåˆ†äº«æ—¶æ·»åŠ  `share_domain` å­—æ®µéªŒè¯:
```javascript
// mail-worker/src/api/share-api.js
if (shareDomain && shareDomain.trim()) {
    // éªŒè¯åŸŸåæ ¼å¼
    const domainRegex = /^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}(:\d+)?$/i;
    if (!domainRegex.test(shareDomain)) {
        throw new BizError('æ— æ•ˆçš„åŸŸåæ ¼å¼', 400);
    }
    
    // é˜²æ­¢ä¿å­˜å ä½ç¬¦
    if (shareDomain === 'share_domain' || shareDomain.includes('{{')) {
        throw new BizError('åŸŸåä¸èƒ½åŒ…å«å ä½ç¬¦', 400);
    }
}
```

### 2. æ·»åŠ æ•°æ®åº“çº¦æŸ
```sql
-- æ·»åŠ  CHECK çº¦æŸé˜²æ­¢é”™è¯¯æ•°æ®
ALTER TABLE share ADD CONSTRAINT check_share_domain 
CHECK (share_domain IS NULL OR (share_domain != 'share_domain' AND share_domain NOT LIKE '%{{%'));
```

### 3. æ·»åŠ ç›‘æ§å‘Šè­¦
- ç›‘æ§åˆ†äº«åˆ›å»ºå¤±è´¥ç‡
- ç›‘æ§åˆ†äº«é“¾æ¥è®¿é—®404ç‡
- è®¾ç½®å‘Šè­¦é˜ˆå€¼,åŠæ—¶å‘ç°é—®é¢˜

### 4. æ”¹è¿›é”™è¯¯æ—¥å¿—
åœ¨åˆ›å»ºåˆ†äº«å¤±è´¥æ—¶è®°å½•æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯:
```javascript
console.error('Create share error:', {
    error: error.message,
    stack: error.stack,
    targetEmail,
    shareName,
    shareDomain,
    timestamp: new Date().toISOString()
});
```

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

### ä¿®å¤è„šæœ¬
- `mail-worker/migrations/005_fix_share_domain_data.sql` - æ•°æ®åº“ä¿®å¤è„šæœ¬

### è¯Šæ–­æŠ¥å‘Š
- `PRODUCTION_ISSUES_DIAGNOSIS_REPORT.md` - ç®€è¦è¯Šæ–­æŠ¥å‘Š
- `PRODUCTION_ISSUES_DIAGNOSIS_2025-01-14.md` - è¯¦ç»†è¯Šæ–­æŠ¥å‘Š
- `PRODUCTION_FIX_SUMMARY.md` - æœ¬æ–‡æ¡£(ä¿®å¤æ€»ç»“)

### ç›¸å…³ä»£ç æ–‡ä»¶
- `mail-worker/src/api/share-api.js` - åˆ†äº«åˆ›å»º API
- `mail-worker/src/service/share-service.js` - åˆ†äº«æœåŠ¡é€»è¾‘
- `mail-worker/src/entity/share.js` - æ•°æ®åº“å®ä½“å®šä¹‰
- `mail-worker/wrangler-production.toml` - ç”Ÿäº§ç¯å¢ƒé…ç½®
- `mail-vue/src/components/share/ShareCreateDialog.vue` - å‰ç«¯åˆ›å»ºåˆ†äº«å¯¹è¯æ¡†

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2025-01-14  
**ä¿®å¤çŠ¶æ€**: éƒ¨åˆ†å®Œæˆ,ç­‰å¾…ç”¨æˆ·æ‰§è¡Œæ•°æ®åº“ä¿®å¤  
**ä¸‹ä¸€æ­¥**: æ‰§è¡Œæ•°æ®åº“ä¿®å¤è„šæœ¬å¹¶éªŒè¯ç»“æœ

